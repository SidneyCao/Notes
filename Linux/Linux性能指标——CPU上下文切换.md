# 一、CPU上下文  
## 1. 概念  
CPU具有极高的运算速度，我们常说的多任务系统，并不是所有任务同时进行，而是CPU在很短的时间内分配算力给不同的任务，以造成任务同时进行的错觉。  
在CPU进行任务切换的过程中，需要知道当前的任务执行到哪，下个任务从哪里加载。这些CPU运行任务前所依赖的必要环境，被称之为```CPU上下文```。 
  
## 2. 上下文切换  
指CPU切换任务之前，将当前任务的上下文存储到内核，然后再加载下一个任务上下文的过程。存储在内核中的上下文会在任务重新调度时被加载，以保证任务的连续性。  
<br>
CPU上下文切换可以分为几种不同的场景：
- 系统调用  
- 进程上下文切换
- 线程上下文切换
- 中断上下文切换  
<br>
当系统中存在大量任务时，即使每个任务本身的占用并不高，花费在任务切换上的CPU占用也会达到一个可观的地步，此时也会造成一些性能上的问题。   
<br>  

# 二、系统调用
进程可以在用户态中运行，也可以在内核态中运行。
<br>
<img src="https://github.com/SidneyCao/Notes/blob/main/img/2-cs.png" width = "50%" />  
当进程需要执行高特权的操作（比如读写文件）时，会被系统调用到内核态，此时就会发生CPU上下文切换。
- CPU寄存器保存用户态的指令位置
- CPU寄存器更新为内核态指令的新位置，再切换到内核空间运行
- CPU寄存器恢复到用户态的指令位置，切换回用户空间运行  

一次系统调用，会发生两次CPU上下文切换。
<br>  

# 三、进程上下文切换
## 1. 和系统调用的区别 
进程由内核来管理和调度，进程上下文切换是从一个进程切换到另一个进程运行，而系统调用一直都是同一个进程在运行。  
<font color=Red>所以，系统调用一般被称为特权模式切换，而不是上下文切换。但实际上，系统调用过程中仍然不可避免地会进行上下文的切换。</font>  

## 2. 性能问题  
保存上下文和恢复上下文也会占用CPU时间，虽然这个时间很短，但当有大量上下文切换发生时，消耗也是相当可观的。  
<br>
<img src="https://github.com/SidneyCao/Notes/blob/main/img/2-pcs.png" width = "70%">
<br>

## 3. 何时进行上下文切换
